{% extends "base.html" %}

{% block title %}赛事{% endblock %}

{% block css %}
<link rel="stylesheet" type="text/css" href="/static/css/game.css">
{% endblock %}

{%block body%}

<div class="container-fluid" style="margin-top:5px;">
	<div class="row">
		<div class="col-xs-12">
			<span class="pull-right" style="color:white;"> 点击右上角分享赛事 ↑ </span>
		</div>
	</div>

	<div class="panel panel-default mt20">
		<div id="playing_title" class="panel-heading text-center" style="font-size:18px;">
		  赛事进行中
		</div>
		<table class="table tbl_player">
			<tr>
				<td class="pull-left"><img class="img-circle img_size red_img_border" src="{{ game.red_rear.headimgurl }}"/></td>
				<td class="pull-left">
				<p>
					{{ game.red_rear.nickname|slice:"10" }}
				</p>
				<p style="color:red;font-size:15px;">
					红队防守
				</p></td>
				<td><p></p></td>
			</tr>

			<tr>
				<td class="pull-left"><img class="img-circle img_size red_img_border" src="{{ game.red_van.headimgurl }}"/></td>
				<td class="pull-left">
				<p>
					{{ game.red_van.nickname|slice:"10" }}
				</p>
				<p style="color:red;font-size:15px;">
					红队前锋
				</p></td>
				<td><p></p></td>
			</tr>
			<tr>
				<td class="pull-left"><img class="img-circle img_size blue_img_border" src="{{ game.blue_van.headimgurl }}"/></td>
				<td class="pull-left">
				<p>
					{{ game.blue_van.nickname|slice:"10" }}
				</p>
				<p style="color:blue;font-size:15px;">
					蓝队前锋
				</p></td>
				<td><p></p></td>
			</tr>
			<tr>
				<td class="pull-left"><img class="img-circle img_size blue_img_border" src="{{ game.blue_rear.headimgurl }}"/></td>
				<td class="pull-left">
				<p>
					{{ game.blue_rear.nickname|slice:"10" }}
				</p>
				<p style="color:blue;font-size:15px;">
					蓝队防守
				</p></td>
				<td><p></p></td>
			</tr>

		</table>
		<div class="panel-footer">
			<p class="text-center center-block" style="background-image:url(/static/images/score_board_bg.png);background-repeat:no-repeat; width:150px; height:37px;">
				<span style="font-size:25px;color:red;" id="red_score"> {{ game.red_score }} </span>
				<span style="font-size:25px;"> : </span>
				<span style="font-size:25px;color:blue;" id="blue_score"> {{ game.blue_score }} </span>
			</p>
			</br>
			{% if user.player == game.red_rear or user.player == game.red_van or user.player == game.blue_van or user.player == game.blue_rear  %}<br />
			<p class="text-center center-block">
				<a href="/games/{{game.id}}/end" class="btn btn-success">结束比赛</a>
			</p>
			{% endif %}
		</div>
	</div>
</div>
<script>
function reload_myself(){
    location.reload(true);
}
function get_game_score(gid){
    url = "/games/"+gid+"/score?nocache="+Math.random();
    $.getJSON(url, function(data){
        $("#red_score").html(data["red_score"]);
        $("#blue_score").html(data["blue_score"]);
    }).fail(function(){
        $("#playing_title").html("<button class='btn btn-link' style='color:black;font-size:18px;' onclick='reload_myself();'>赛事进行中</button>");
    });
}
// setInterval('get_game_score({{game.id}})', 3000);

var ws;

function send(data) {
	if(ws.readyState == ws.OPEN){
        ws.send(JSON.stringify(data));
   } else {
	    connect();
   }
}

function login() {
	var data = {
		"cmd": "login_req",
		"data": {
			"appid": "b950a3c5b12c412d804b8bdcad55a84a",
			"uid": "f370cb28350d43eba0bf117eaca50823",
			"token": "c07bb7a9a4fd44519a15fa4cc62b4aa5",
			"p0_type": "attrs_v4",
			"heartbeat_interval": 60
		}
	};
	send(data);
}

function ping() {
	var data = {
		"cmd": "ping"
	};
	send(data);
}

function connect() {
	var m2m = "ws://m2m.gizwits.com:8080/ws/app/v1"
	ws = new WebSocket(m2m);
	ws.onopen = function(event) {
		console.log("onopen");
		login();
	};
	ws.onclose = function(event) {
		console.log("onclose");
	}
	ws.onmessage = function(event) {
		console.log("onmessage");
		var data = JSON.parse(event.data);
		console.log(data);
		if (data["cmd"] == "s2c_noti") {
			var red = data["data"]["attrs"]["红方进球数"];
			var blue = data["data"]["attrs"]["蓝方进球数"];
			$("#red_score").text(red);
        	$("#blue_score").text(blue);
		}
	}
	ws.onerror = function(event) {
		console.log("onerror");
	}
};

connect();

setInterval(ping, 10000);
</script>
{% endblock %}

